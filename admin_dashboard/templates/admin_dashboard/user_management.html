{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}User Management - HagerBet Admin{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
            <p class="text-gray-600">Manage customers, sellers, and user verification</p>
        </div>
        <div class="flex space-x-3">
            <select id="role-filter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Roles</option>
                <option value="customer">Customers</option>
                <option value="seller">Sellers</option>
                <option value="admin">Admins</option>
            </select>
            <select id="verification-filter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Users</option>
                <option value="pending">Pending Verification</option>
                <option value="verified">Verified Only</option>
            </select>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orders</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentRole = '';
    let currentVerification = '';

    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        
        document.getElementById('role-filter').addEventListener('change', function(e) {
            currentRole = e.target.value;
            currentPage = 1;
            loadUsers();
        });
        
        document.getElementById('verification-filter').addEventListener('change', function(e) {
            currentVerification = e.target.value;
            currentPage = 1;
            loadUsers();
        });
    });

    async function loadUsers() {
        try {
            let url = `/admin-dashboard/api/users/?page=${currentPage}`;
            if (currentRole) url += `&role=${currentRole}`;
            if (currentVerification) url += `&verification=${currentVerification}`;
            
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                renderUsersTable(data);
            }
        } catch (error) {
            console.error('Failed to load users:', error);
            showToast('Failed to load users', 'error');
        }
    }

    function renderUsersTable(data) {
        const tbody = document.getElementById('users-table-body');
        
        if (data.users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                        <p class="text-lg">No users found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = data.users.map(user => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                        <div class="text-sm font-medium text-gray-900">${user.email}</div>
                        <div class="text-sm text-gray-500">${user.first_name} ${user.last_name}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full capitalize ${
                        user.role === 'admin' ? 'bg-red-100 text-red-800' :
                        user.role === 'seller' ? 'bg-purple-100 text-purple-800' :
                        'bg-blue-100 text-blue-800'
                    }">
                        ${user.role}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(user.date_joined).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${user.order_count}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        user.email_verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                        ${user.email_verified ? 'Verified' : 'Pending'}
                    </span>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ml-2 ${
                        user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${user.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${!user.email_verified ? `
                        <button onclick="verifyUser(${user.id})" class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-check-circle"></i> Verify
                        </button>
                    ` : ''}
                    <button onclick="toggleUserActive(${user.id}, ${user.is_active})" class="${
                        user.is_active ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'
                    }">
                        <i class="fas ${user.is_active ? 'fa-user-slash' : 'fa-user-check'}"></i>
                        ${user.is_active ? 'Deactivate' : 'Activate'}
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function verifyUser(userId) {
        try {
            const response = await fetch(`/admin-dashboard/api/users/verify/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (response.ok) {
                showToast('User verified successfully', 'success');
                loadUsers();
            } else {
                showToast('Failed to verify user', 'error');
            }
        } catch (error) {
            console.error('Failed to verify user:', error);
            showToast('Failed to verify user', 'error');
        }
    }

    async function toggleUserActive(userId, isCurrentlyActive) {
        const action = isCurrentlyActive ? 'deactivate' : 'activate';
        if (!confirm(`Are you sure you want to ${action} this user?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin-dashboard/api/users/${userId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    action: 'toggle_active'
                })
            });
            
            if (response.ok) {
                showToast(`User ${action}d successfully`, 'success');
                loadUsers();
            } else {
                showToast(`Failed to ${action} user`, 'error');
            }
        } catch (error) {
            console.error(`Failed to ${action} user:`, error);
            showToast(`Failed to ${action} user`, 'error');
        }
    }
</script>
{% endblock %}